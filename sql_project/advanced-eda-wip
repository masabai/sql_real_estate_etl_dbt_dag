-- ======================================================
-- Step 6: Analytical Queries / EDA with Derived Features
-- ======================================================

-- 1️⃣ Distribution of sales over time
WITH sales_by_year AS (
    SELECT
        list_year,
        COUNT(*) AS sales_count,
        AVG(sale_amount) AS avg_sale,
        AVG(sale_amount - assessed_value) AS avg_price_difference,
        AVG(sale_amount / NULLIF(assessed_value,0)) AS avg_sales_ratio
    FROM staging.real_estate_clean
    GROUP BY list_year
)
SELECT *
FROM sales_by_year
ORDER BY list_year;

-- 2️⃣ Top 10 towns by sales volume with ranking
WITH town_stats AS (
    SELECT
        town,
        COUNT(*) AS sales_count,
        AVG(sale_amount) AS avg_sale,
        AVG(sale_amount - assessed_value) AS avg_price_difference,
        AVG(sale_amount / NULLIF(assessed_value,0)) AS avg_sales_ratio,
        RANK() OVER (ORDER BY COUNT(*) DESC) AS town_rank
    FROM staging.real_estate_clean
    GROUP BY town
)
SELECT *
FROM town_stats
WHERE town_rank <= 10
ORDER BY sales_count DESC;

-- 3️⃣ Property type breakdown with running total
WITH prop_stats AS (
    SELECT
        property_type,
        COUNT(*) AS count,
        AVG(sale_amount) AS avg_sale,
        AVG(sale_amount - assessed_value) AS avg_price_difference,
        AVG(sale_amount / NULLIF(assessed_value,0)) AS avg_sales_ratio
    FROM staging.real_estate_clean
    GROUP BY property_type
)
SELECT *,
       SUM(count) OVER (ORDER BY count DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumulative_count
FROM prop_stats
ORDER BY count DESC;

-- 4️⃣ Monthly sales trends with moving average
WITH monthly_sales AS (
    SELECT
        EXTRACT(YEAR FROM date_recorded) AS sale_year,
        EXTRACT(MONTH FROM date_recorded) AS sale_month,
        COUNT(*) AS sales_count,
        ROUND(AVG(sale_amount::NUMERIC),2) AS avg_sale,
        ROUND(AVG(sale_amount / NULLIF(assessed_value,0)),2) AS avg_sales_ratio
    FROM staging.real_estate_clean
    GROUP BY sale_year, sale_month
)
SELECT *,
       AVG(avg_sale) OVER (PARTITION BY sale_year ORDER BY sale_month ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS ma3_avg_sale
FROM monthly_sales
ORDER BY sale_year, sale_month;

